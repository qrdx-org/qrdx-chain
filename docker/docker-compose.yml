x-qrdx-node-base: &qrdx-node-base
  build:
    context: ".."
    dockerfile: "./docker/Dockerfile"
  restart: unless-stopped
  working_dir: /app
  env_file: ["../.env"]
  labels: ["qrdx.node=true"]
  networks: [qrdx-net]
  volumes:
    - type: volume
      target: /app
    - type: volume
      source: node-registry
      target: /shared/node-registry
    - type: volume
      source: node-topology
      target: /shared/node-topology
      read_only: true
  environment:
    &qrdx-node-env
    qrdx_DATABASE_HOST: 'postgres'
    qrdx_NODE_HOST: '0.0.0.0'

services:
  topology:
    image: python:3.12-alpine
    working_dir: /app
    command: >
      sh -c "pip install --no-cache-dir pyyaml >/dev/null && python /app/generate-topology.py"
    volumes:
      - ./generate-topology.py:/app/generate-topology.py:ro
      - ./docker-compose.yml:/project/docker-compose.yml:ro
      - node-topology:/shared/node-topology
    networks: [qrdx-net]

  postgres:
    image: postgres:14
    env_file: ["../.env"]
    volumes: [postgres_data:/var/lib/postgresql/data]
    networks: [qrdx-net]

  node-3006:
    <<: *qrdx-node-base
    hostname: node-3006
    volumes: [node_3006_data:/app, node-registry:/shared/node-registry, node-topology:/shared/node-topology:ro]
    depends_on:
      topology: { condition: service_completed_successfully }
      postgres: { condition: service_started }
    ports: ["3006:3006"]
    environment:
      <<: *qrdx-node-env
      NODE_NAME: 'node-3006'
      qrdx_NODE_PORT: '3006'
      
      # This variable specifies either the selection criteria or a fixed address for the bootstrap-node.
      # It essentially connects the node to qrdx's P2P Network. Defaults to 'self' if left blank.
      # Accepted values:
      #   - 'self': Uses the nodeâ€™s own internal address. If this value is set but no peers connect to this
      #           node, then it will be isolated from the rest of P2P network. 
      #   - 'discover': Selects an address from the shared peer registry at /registry/public_nodes.txt.
      #   - The address of a qrdx Node that is reachable via the Internet or internal network.
      qrdx_BOOTSTRAP_NODE: 'https://node.qrdx.network'
      
      # This variable enables public tunnleing via Pinggy.io for up to 60 minutes.
      #ENABLE_PINGGY_TUNNEL: 'true'
 
      # This variable specifies the the publically reachable address of the node itself, and is required for
      # publically facing nodes. When left blank it will default to http://${NODE_NAME}:${qrdx_NODE_PORT}. 
      # Setting ENABLE_PINGGY_TUNNEL to 'true' will override this variable with the public URL that is
      # assigneed to the node via Pinggy.io.
      qrdx_SELF_URL: ''

volumes:
  node-topology:
  node-registry:
  node_3006_data:
  postgres_data:

networks:
  qrdx-net:
    driver: bridge
